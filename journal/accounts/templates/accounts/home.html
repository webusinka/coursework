<!-- home.html -->
{% extends 'base.html' %}

{% block title %}Домашняя страница{% endblock %}

{% block content %}
<style>
    .fixed-header {
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        padding: 5px;
        z-index: 1000;
        text-align: center;
    }

    .content {
        margin-top: 90px;
        text-align: center;
    }

    #questions-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .question {
        flex: 1 1 45%;
        margin: 10px;
        text-align: center;
    }

    .reset-text {
        text-decoration: underline;
        cursor: pointer;
        color: blue;
        margin-bottom: 10px;
    }

    .error-message {
        color: red;
        margin-top: 10px;
        display: none;
    }
</style>

<div class="fixed-header">
    <h1>Добро пожаловать на сайт<br>отслеживания направления развития!</h1>
</div>

<div class="content">
    {% if user.is_authenticated %}
        {% if user.is_staff %}
            <h2>Список зарегистрированных студентов:</h2>
            <table border="1">
                <tr>
                    <th>Имя пользователя</th>
                    <th>Посещаемость(%)</th>
                    <th>Основы ИБ</th>
                    <th>Программирование</th>
                    <th>Безопасность ОС</th>
                    <th>Комментарий от преподавателя</th>
                </tr>
                {% for user in users %}
                    <tr>
                        <td>{{ user.username }}</td>
                        {% for performance in performances %}
                            {% if performance.user == user %}
                                <td>{{ performance.attendance|floatformat:2 }}</td>
                                <td>{{ performance.oib_score }}</td>
                                <td>{{ performance.programming_score }}</td>
                                <td>{{ performance.os_security_score }}</td>
                                <td>{{ performance.direction_comment }}</td>
                            {% endif %}
                        {% empty %}
                            <td colspan="5">Нет данных о успеваемости</td>
                        {% endfor %}
                    </tr>
                {% empty %}
                <tr>
                    <td colspan="2">Нет зарегистрированных пользователей.</td>
                </tr>
                {% endfor %}
            </table>
            <h2>Изменить данные студента:</h2>
            <form id="update-form" method="POST" action="{% url 'update_performance' %}">
                {% csrf_token %}
                <label for="username">Имя пользователя:</label>
                <select id="username" name="username" required>
                    <option value="" disabled selected>Выберите студента</option> <!-- Добавляем пустой элемент -->
                    {% for user in users %}
                        <option value="{{ user.id }}">{{ user.username }}</option>
                    {% endfor %}
                </select>
                
                <label for="field">Поле для изменения:</label>
                <select id="field" name="field" required>
                    <option value="" disabled selected>Выберите поле</option> <!-- Добавляем пустой элемент -->
                    <option value="attendance">Посещаемость (%)</option>
                    <option value="oib_score">Оценка по ОИБ</option>
                    <option value="programming_score">Оценка по программированию</option>
                    <option value="os_security_score">Оценка по безопасности ОС</option>
                    <option value="direction_comment">Комментарий по направлению</option>
                </select>
                
                <label for="new_value">Новое значение:</label>
                <input type="text" id="new_value" name="new_value" required placeholder="Введите новое значение"> <!-- Добавляем подсказку -->
                
                <button type="submit" style="width: 150px;">Изменить</button>
            </form>
        {% else %}
            {% if questions %}
                <h2>Пройдите тест</h2>
                <p style="font-size: 14px; color: gray;">Отвечая на вопрос, вы должны выбрать, близко вам предложенное утверждение или нет.</p>
                <form id="test-form" method="POST" action="{% url 'submit_test' %}">
                    {% csrf_token %}
                    <div id="questions-container">
                        {% for question in questions %}
                            <div class="question">
                                <label>{{ question.text }}</label><br>
                                {% for answer in question.answers.all %}
                                    <input type="radio" name="question_{{ question.id }}" value="{{ answer.id }}" onchange="hideErrorMessage()"> {{ answer.text }}<br>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                    <span class="reset-text" onclick="resetAnswers()">Стереть ответы</span>
                    <div class="error-message" id="error-message">Пожалуйста, ответьте на все вопросы перед отправкой.</div>
                    <div style="display: flex; justify-content: center; margin-top: 20px;">
                        <button type="button" class="submit-button" style="width: 150px;" onclick="validateForm()">Отправить</button>
                    </div>
                </form>
            {% else %}
                <p>Нет доступных вопросов для теста.</p>
            {% endif %}
        {% endif %}
    {% else %}
        <p>Вы не авторизованы.</p>
    {% endif %}
</div>

<script>
    document.getElementById('update-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Предотвращаем стандартное поведение формы

        // Создаем объект с данными формы
        const data = {
            user_id: document.getElementById('username').value, // user_id
            new_value: document.getElementById('new_value').value, // Новое значение
            field: document.getElementById('field').value // Поле для обновления
        };

        // Отправляем данные на сервер в формате JSON
        fetch('{% url "update_performance" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', // Устанавливаем заголовок на application/json
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data) // Сериализуем объект в JSON
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Данные успешно обновлены!');
                
                // Обновляем соответствующую ячейку в таблице
                const userId = document.getElementById('username').value; // user_id
                const field = document.getElementById('field').value; // Поле для обновления
                const newValue = document.getElementById('new_value').value; // Новое значение

                // Находим ячейку по user_id и полю
                const cell = document.querySelector(`tr td[data-user-id="${userId}"][data-field="${field}"]`);
                if (cell) {
                    cell.innerText = newValue; // Обновляем текст ячейки
                }
            } else {
                alert('Ошибка: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при обновлении данных.');
        });
    });
    
    function resetAnswers() {
        const radios = document.querySelectorAll('input[type="radio"]');
        //сбрасываем состояние
        radios.forEach(radio => {
            radio.checked = false;
        });
        document.getElementById('error-message').style.display = 'none';
    }

    function hideErrorMessage() {
        document.getElementById('error-message').style.display = 'none';
    }

    function validateForm() {
        const questions = document.querySelectorAll('#questions-container .question');
        let allAnswered = true;

        questions.forEach(question => {
            const radios = question.querySelectorAll('input[type="radio"]');
            const isAnswered = Array.from(radios).some(radio => radio.checked);
            if (!isAnswered) {
                allAnswered = false;
            }
        });

        if (!allAnswered) {
            //если не все вопросы отвечены
            document.getElementById('error-message').style.display = 'block';
        } else {
            //или отправляем форму
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('test-form').submit();
        }
    }
</script>
{% endblock %}